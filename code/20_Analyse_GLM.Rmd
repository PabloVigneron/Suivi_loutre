---
title: "Loutre_analyse"
author: "Pablo"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
#  bookdown::word_docume
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, warning = FALSE, message = FALSE)
```

# Importation des packages

```{r}
library(tidyverse)
library(gridExtra)
library(lubridate)
library(sf)
library(mapview)
library(maptiles)
library(tidyterra)
library(kableExtra)
library(knitr)
library(RVAideMemoire)
library(emmeans)
library(car)
library(MASS)
```

# Importation des donn√©es - Secteur J25 : Petit Tregor 

```{r}
base_tregor <-
  readxl::read_xlsx(path = '../raw_data/export_suiviloutrelocal_telecharger_csv_2025_04_03_10h58m17.xlsx') %>%
  select(
    id_dataset,
    code_secteur,
    code_site,
    nom_site,
    x_l93,
    y_l93,
    date_visite,
    observateurs,
    condition_prospection,
    nom_taxon,
    nom_complet_taxon,
    techn_observation,
    statut_observation,
    nb_ep_tot,
    nb_ep_w,
    nb_ep_dnf,
    nb_ep_df
  ) %>%
  mutate(
    annee = year(date_visite),
    mois = month(date_visite),
    jour = day(date_visite),
    nb_ep_w = abs(nb_ep_w),
    statut_observation = ifelse(str_detect(statut_observation, '^Pr'), yes = 'Pr√©sent', no = 'Absent')
  ) %>% 
  filter(nom_complet_taxon =='Lutra lutra',
         !(id_dataset == 85 & code_secteur == "FR5300006"),
         code_secteur != "J401")
```


```{r}
base_j25 <- base_tregor %>%
  filter(code_secteur == "J25") %>%
  mutate(statut_presence = ifelse(as.character(statut_observation) == "Pr√©sent", 1, 0))
```
# Analyse statistiques - Mod√®le Lin√©aire G√©n√©ralis√© (GLM)

##  Mod√®le 1 : Le statut d'observation depend de l'ann√©e


### Construction du mod√®le 


#### **Definition des types de variables**

+ **Variable r√©ponse** : Statut_pr√©sence, variable qualitative binaire, nominale 
+ **Variable explicative** : Annee, variable qualitative ordinale fixe


#### **Choix de la distribution de r√©f√©rence**

 => **Distribution Binomiale**


#### **Choix de la fonction de lien**

=> **logit** 

```{r}
mod1 <- glm(statut_presence~annee, family=binomial(link = "logit"), data = base_j25)

```

###  V√©rification de l‚Äôajustement du mod√®le aux donn√©es

* **V√©rification de la lin√©arit√© du mod√®le**

```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod1)

```

La relation semble lin√©aire, il n‚Äôy a aucune structuration dans les r√©sidus
autrement dit ind√©pendance entre les valeurs pr√©dites (ùúá) et les r√©sidus (ùúÄ)


* **V√©rification de la relation entre mu et v**

```{r,fig.cap="",fig.width = 9, fig.height = 6}
summary(mod1)

```

```{r}
heteroscedasticite <- function(deviance_residuelle, dl_residuelle){
  deviance_residuelle /dl_residuelle
}

heteroscedasticite(505.20, 412)
```

= > Seuil de 1 (ou 1,5), On observe une l√©g√®re sur-dispersion des r√©sidus

Probl√®me de surdispersion (h√©t√©rosc√©dasticit√© diff√©rente de l‚Äôattendu)

#### **Remplacer la loi binomiale par une loi quasi-binomiale**

```{r}
mod1.1 <- glm(statut_presence~annee,quasibinomial(link = "logit"), data = base_j25)

```

* **V√©rification de la lin√©arit√© du mod√®le**

```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod1.1)

```

La relation semble lin√©aire, il n‚Äôy a aucune structuration dans les r√©sidus
autrement dit ind√©pendance entre les valeurs pr√©dites (ùúá) et les r√©sidus (ùúÄ)
 
 
* **V√©rification de la relation entre mu et v**

```{r, fig.cap="",fig.width = 7, fig.height = 5}
summary(mod1.1)

```

```{r}
heteroscedasticite <- function(deviance_residuelle, dl_residuelle){
  deviance_residuelle /dl_residuelle
}

heteroscedasticite(505.20, 412)

```
=> Seuil de 1 (ou 1,5), On observe une sur-dispersion des r√©sidus


#### Introduction d'un facteur al√©atoiree √† 1 modalit√© / donn√©e ? GLMM



### Exploitation du mod√®le

```{r}
anova(mod1)
```
```{r}
anova(mod1.1)
```

##  Mod√®le 2 : Le nombre total de marquage depend de l'ann√©e


### Construction du mod√®le 


#### **Definition des types de variables**

+ **Variable r√©ponse** : nb_ep_tot, variable quantitative discrete
+ **Variable explicative** : Annee, variable qualitative ordinale fixe


#### **Choix de la distribution de r√©f√©rence**

 => **Distribution de Poisson**


#### **Choix de la fonction de lien**

=> **ln** 


```{r}
mod2 <- glm(nb_ep_tot~annee, family=poisson(link = "log"), data = base_j25)

```

###  V√©rification de l‚Äôajustement du mod√®le aux donn√©es

* **V√©rification de la lin√©arit√© du mod√®le**

```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod2)

```

La relation semble lin√©aire, il n‚Äôy a aucune structuration dans les r√©sidus
autrement dit ind√©pendance entre les valeurs pr√©dites (ùúá) et les r√©sidus (ùúÄ) ??


#### **Remplacer la fonction de lien "ln" par "identit√©"**

```{r}
mod2.1 <- glm(nb_ep_tot~annee, family=poisson(link = "identity"), data = base_j25)

```

* **V√©rification de la lin√©arit√© du mod√®le**

```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod2.1)
```
La relation semble lin√©aire, il n‚Äôy a aucune structuration dans les r√©sidus
autrement dit ind√©pendance entre les valeurs pr√©dites (ùúá) et les r√©sidus (ùúÄ) ??

Ne change pas grand chose entre mod2 et mod2.2, on conserve mod2


* **V√©rification de la relation entre mu et v**

```{r,fig.cap="",fig.width = 9, fig.height = 6}
summary(mod2)

```



```{r}
heteroscedasticite <- function(deviance_residuelle, dl_residuelle){
  deviance_residuelle /dl_residuelle
}
heteroscedasticite(669.99, 412)
```


=> Sup√©rieur au seuil de 1 (ou 1,5), sur-dispersion des r√©sidus. 
Probl√®me de surdispersion (h√©t√©rosc√©dasticit√© diff√©rente de l‚Äôattendu), 
la relation entre mu et v n'est pas v√©rifi√©.


```{r,fig.cap="",fig.width = 9, fig.height = 6}
summary(mod2.1)

```
```{r}
heteroscedasticite <- function(deviance_residuelle, dl_residuelle){
  deviance_residuelle /dl_residuelle
}
heteroscedasticite(671.67, 412)
```
=> La modification de la fonction de lien rend la surdispersion des r√©sidus plus importante, on conserve donc le mod√®le 2 

#### **Remplacer la loi de Poisson par une loi binomiale n√©gative**

```{r}
mod2.2 <- MASS::glm.nb(nb_ep_tot~annee, family= binomial(link = "log"), data = base_j25)

```
 
* **V√©rification de la lin√©arit√© du mod√®le**

```{r, fig.cap="",fig.width = 7, fig.height = 5}

plotresid(mod2.2)
```




### Exploitation du mod√®le
```{r}
Anova (mod2)

```

