---
title: "Loutre"
author: "Pablo"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
#  bookdown::word_docume
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, warning = FALSE, message = FALSE)
```

# Importation des packages

```{r}
library(tidyverse)
library(gridExtra)
library(lubridate)
library(sf)
library(mapview)
library(maptiles)
library(tidyterra)
library(kableExtra)
library(knitr)
library(janitor)
library(RVAideMemoire)
library(emmeans)
library(car)
library(MASS)
library(lme4)
library(MuMIn)
library(stringr)
library(stringi)
```


# Importation des données - Secteur : Lieu Greve

```{r}
base_greve_raw <-
  readxl::read_xls(path = '../raw_data/Suivi loutre Lieue de Greve octobre 24.xls',
                   skip = 1,
                   col_names = T) 
```


```{r}
base_greve <- base_greve_raw %>%
  janitor::clean_names() %>%
  dplyr::select(
    point_n,
    itineraire,
    x,
    y,
    commune,
    cours_deau,
    bilan_choix_du_site,
    epreinte_oct20,
    date_suivi_fev_mars21,
    marquage_suivi_fev_mars21,
    date_suivi_oct21,
    marquage_suivi_oct21,
    observateurs_suivi_oct21,
    date_suivi_mars22,
    marquage_suivi_mars22,
    observateurs_suivi_mars22,
    date_suivi_decembre22,
    marquage_suivi_decembre22,
    observateurs_suivi_decembre22,
    date_suivi_mars23,
    marquage_suivi_mars23,
    observateurs_suivi_mars23,
    date_suivi_octobre_24,
    marquage_suivi_octobre_24,
    observateurs_suivi_octobre_24
  ) %>%
  dplyr::rename(
    code_site = point_n,
    y = x,
    x = y,
    marquage_suivi_oct_20 = epreinte_oct20
  ) %>%
  dplyr::mutate(date_suivi_octobre_24 = as.Date(as.numeric(date_suivi_octobre_24), origin = "1899-12-30")) %>%
  dplyr::mutate(date_suivi_oct_20 = as.Date("2020-10-01")) %>%
  dplyr::mutate(across(
    c(
      date_suivi_fev_mars21,
      date_suivi_oct21,
      date_suivi_mars22,
      date_suivi_decembre22,
      date_suivi_mars23,
      date_suivi_oct_20
    ),
    ~ as.POSIXct(.x)
  )) %>%
  mutate(across(starts_with("marquage_suivi_"), as.character)) %>%
  tidyr::pivot_longer(
    cols = c(
      date_suivi_oct_20,
      marquage_suivi_oct_20,
      date_suivi_fev_mars21,
      marquage_suivi_fev_mars21,
      date_suivi_oct21,
      marquage_suivi_oct21,
      observateurs_suivi_oct21,
      date_suivi_mars22,
      marquage_suivi_mars22,
      observateurs_suivi_mars22,
      date_suivi_decembre22,
      marquage_suivi_decembre22,
      observateurs_suivi_decembre22,
      date_suivi_mars23,
      marquage_suivi_mars23,
      observateurs_suivi_mars23,
      date_suivi_octobre_24,
      marquage_suivi_octobre_24,
      observateurs_suivi_octobre_24
    ),
    names_to = c(".value", "session"),
    names_pattern = "(date_suivi|marquage_suivi|observateurs_suivi)_(.*)"
  ) %>%
  rename(
    date_visite = date_suivi,
    statut_presence = marquage_suivi,
    observateurs = observateurs_suivi
  ) %>%
  dplyr::mutate(
    annee = year(date_visite),
    mois = month(date_visite),
    jour = day(date_visite),
    code_site = as.factor(code_site),
    statut_presence = case_when(
      tolower(statut_presence) == "oui" ~ 1,
      suppressWarnings(as.numeric(statut_presence)) >= 1 ~ 1,
      tolower(statut_presence) %in% c("non", "peut_etre") ~ 0,
      TRUE ~ 0
    ),
    statut_presence = as.factor (statut_presence),
    jour = ifelse(jour == 1, NA, jour),
    annee = ifelse(annee == 2002, 2021, annee),
    y = str_replace_all(y, ",", ""),
    x = str_replace_all(x, " ", ""),
    passage = ifelse(mois == "3" | mois == "2", 1, 2),
    date_visite = ifelse(
      date_visite == as.Date("2002-02-24"),
      "2021-02-24",
      as.character(date_visite)
    ),
    observateurs_clean = observateurs %>%
      str_to_lower() %>%
      str_replace_all(" et ", "_") %>%
      str_replace_all("[[:space:]]+", "_") %>%
      str_replace_all("[^a-z0-9_]", "") %>%
      stri_trans_general("latin-ascii")
  ) %>%
  dplyr::mutate(observateurs_clean = as.factor(
    ifelse(
      observateurs_clean == "maxime_chapelle_romain_salaun",
      "maxime_chapelle_romain_salun",
      observateurs_clean
    )
  )) %>%
  dplyr::filter(!is.na(code_site), !is.na(itineraire))


```



Correction : 
- X et Y sont inversé
- Supprimer la dernière ligne + ligne 72
- si statut_présence = 'oui' ou >= 1 , =1 sinon = 0 
- pb encodage date octobre 2024
- session fev_mars 2021 --> noté 2002 corriger 
ATTENTION - LA DATE 1 octobre 2020 Est FICTIVE pour pouvoir créer la colonne année et mois


# Représentation cartographique du secteur d'étude et des sites correspondants

```{r, fig.cap="",fig.width = 7, fig.height = 5}
sites_geo <- base_greve %>%
  dplyr::mutate(
    y = str_replace_all(y, ",", "."),
    x = str_replace_all(x, ",", "."),
    y = as.numeric(y),
    x = as.numeric(x)
  ) %>%
  dplyr::filter(!is.na(x) | !is.na(y)) %>%
  dplyr::select(commune, statut_presence, annee, x, y) %>%
  sf::st_as_sf(coords = c("x", "y"), crs = sf::st_crs(4326)) %>%
  st_transform(crs = 2154)

mapview::mapview(sites_geo, col.regions =  "darkseagreen3")
```
# Statut d'observation des sites prospectée en fonction des années, 1er passage (printemps)

```{r, fig.cap="Statut d'observation des sites prospectée en fonction des années ",fig.width = 9, fig.height = 7}


base_greve_spring <- base_greve %>%
  mutate(annee = year(date_visite)) %>%
  dplyr::filter(passage == 1)
  

all_combos <- expand_grid(code_site = unique(base_greve$code_site),
                          annee = unique(base_greve$annee))

obs_complete <- all_combos %>%
  left_join(base_greve %>% 
              dplyr::select(code_site, annee, statut_presence),
            by = c("code_site", "annee")) %>%
  dplyr::mutate(
    statut_final = case_when(
      statut_presence == "1" ~ "1",
      statut_presence == "0" ~ "0",
      TRUE ~ "Non prospecté"
    )
  )

ggplot(obs_complete, aes(x = annee, y = code_site, fill = statut_final)) +
  geom_tile(color = "white", linewidth = 0.3) +
  scale_fill_manual(
    values = c(
      "1" = "darkseagreen3",
      "0" = "indianred1",
      "Non prospecté" = "grey80"
    )
  ) +
  labs(x = "Année",
       y = "Site",
       title = "Suivi des sites de prospection - Secteur Lieu greve",
       fill = "Statut d'observation") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.border = element_rect(color = "black", fill = NA),
    legend.background = element_rect(fill = "grey95", color = "black")
  )
```

# Statut d'observation des sites prospectée en fonction des années, 2e passage (hiver)

```{r, fig.cap="Statut d'observation des sites prospectée en fonction des années ",fig.width = 9, fig.height = 7}


base_greve_winter <- base_greve %>%
  dplyr::filter(passage == 2)%>%
  mutate(annee = year(date_visite)) 
  

all_combos <- expand_grid(code_site = unique(base_greve$code_site),
                          annee = unique(base_greve$annee))

obs_complete <- all_combos %>%
  left_join(base_greve %>% 
              dplyr::select(code_site, annee, statut_presence),
            by = c("code_site", "annee")) %>%
  dplyr::mutate(
    statut_final = case_when(
      statut_presence == "1" ~ "1",
      statut_presence == "0" ~ "0",
      TRUE ~ "Non prospecté"
    )
  )

ggplot(obs_complete, aes(x = annee, y = code_site, fill = statut_final)) +
  geom_tile(color = "white", linewidth = 0.3) +
  scale_fill_manual(
    values = c(
      "1" = "darkseagreen3",
      "0" = "indianred1",
      "Non prospecté" = "grey80"
    )
  ) +
  labs(x = "Année",
       y = "Site",
       title = "Suivi des sites de prospection - Secteur Lieu greve",
       fill = "Statut d'observation") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.border = element_rect(color = "black", fill = NA),
    legend.background = element_rect(fill = "grey95", color = "black")
  )
```

###


```{r}
unique(base_greve$statut_presence)

base_greve_clean <- base_greve %>%
  mutate(
    statut_presence = trimws(statut_presence)  # supprime les espaces
  )
all_combos <- expand_grid(
  code_site = unique(base_greve_clean$code_site),
  annee = unique(base_greve_clean$annee),
  passage = unique(base_greve_clean$passage)
)

obs_complete <- all_combos %>%
  left_join(
    base_greve_clean %>% dplyr::select(code_site, annee, passage, statut_presence),
    by = c("code_site", "annee", "passage")
  ) %>%
  mutate(
    statut_final = case_when(
      statut_presence == "1" ~ "Présent",
      statut_presence == "0" ~ "Absent",
      is.na(statut_presence) ~ "Non prospecté"
    )
  )
ggplot(obs_complete, aes(x = passage, y = code_site, fill = statut_final)) +
  geom_tile(color = "white", linewidth = 0.3) +
  scale_fill_manual(
    values = c(
      "Présent" = "darkseagreen3",
      "Absent" = "indianred1",
      "Non prospecté" = "grey80"
    ),
    drop = FALSE  # force à afficher toutes les catégories même si manquantes
  ) +
  facet_wrap(~ annee, ncol = 1) +
  labs(
    x = "Passage",
    y = "Site",
    title = "Suivi des passages par site et année - Secteur Lieu Grève",
    fill = "Statut d'observation"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.border = element_rect(color = "black", fill = NA),
    legend.background = element_rect(fill = "grey95", color = "black")
  )


```


##  Modèle 1 : Le statut d'observation depend de l'année pour le passage printemps

```{r}
base_greve_year_factor <- base_greve %>%
  mutate(annee = as.factor(annee))%>%
  filter(passage == 1)

```

```{r}
summary(base_greve_year_factor)

```


### Construction du modèle 


#### **Definition des types de variables**

+ **Variable réponse** : Statut_présence, variable qualitative binaire, nominale 
+ **Variable explicative** : 
+ Annee, variable qualitative ordinale 
+ Site, variable qualitative ordinale 

#### **Choix de la distribution de référence**

 => **Distribution Binomiale**


#### **Choix de la fonction de lien**

=> **logit** 

#### **Modèle mixte**


```{r}
mod1.0<- glmer(statut_presence~annee+(1|code_site), family=binomial(link = "logit"), data = base_greve_year_factor)
```

###  Vérification de l’ajustement du modèle aux données


**Vérification de l'indépendance des résidus**

```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod1.0)

```


#### **Remplacer la fonction de lien "logit" par "probit"**
```{r}
mod1.1<- glmer(statut_presence~annee+(1|code_site), family=binomial(link = "probit"), data = base_greve_year_factor)
```

###  Vérification de l’ajustement du modèle aux données


**Vérification de l'indépendance des résidus**
```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod1.1)

```
**Valeur des coefficients (estimate)**

```{r}
summary(mod1.1)
```
## Capacité explicative globale


```{r}
r.squaredGLMM(mod1.0)
```


```{r}
r.squaredGLMM(mod1.1)

```


### Exploitation du modèle

#### **Test de Wald**

```{r}
Anova(mod1.1)

```


##  Modèle 2 : Le statut d'observation depend de l'année pour le passage hiver

```{r}
base_greve_year_factor <- base_greve %>%
  mutate(annee = as.factor(annee))%>%
  filter(passage == 2)

```

```{r}
summary(base_greve_year_factor)

```


### Construction du modèle 


#### **Definition des types de variables**

+ **Variable réponse** : Statut_présence, variable qualitative binaire, nominale 
+ **Variable explicative** : 
+ Annee, variable qualitative ordinale 
+ Site, variable qualitative ordinale 

#### **Choix de la distribution de référence**

 => **Distribution Binomiale**


#### **Choix de la fonction de lien**

=> **logit** 

#### **Modèle mixte**


```{r}
mod2.0<- glmer(statut_presence~annee+(1|code_site), family=binomial(link = "logit"), data = base_greve_year_factor)
```

###  Vérification de l’ajustement du modèle aux données


**Vérification de l'indépendance des résidus**

```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod2.0)

```


#### **Remplacer la fonction de lien "logit" par "probit"**
```{r}
mod2.1<- glmer(statut_presence~annee+(1|code_site), family=binomial(link = "probit"), data = base_greve_year_factor)
```

###  Vérification de l’ajustement du modèle aux données


**Vérification de l'indépendance des résidus**
```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod2.1)

```
**Valeur des coefficients (estimate)**

```{r}
summary(mod2.1)
```
## Capacité explicative globale


```{r}
r.squaredGLMM(mod2.0)
```


```{r}
r.squaredGLMM(mod2.1)

```


### Exploitation du modèle

#### **Test de Wald**

```{r}
Anova(mod2.1)

```




##  Modèle 3 : Le statut d'observation depend de l'année et de l'observateurs

```{r}
base_greve_year_factor <- base_greve%>%
  mutate(annee = as.factor(annee), 
         passage = as.factor(passage))%>%
  dplyr::select(
    code_site, 
    annee,
    observateurs_clean, 
    passage, 
    statut_presence
  )


```

```{r}
summary(base_greve_year_factor)

```
### Construction du modèle 


#### **Definition des types de variables**

+ **Variable réponse** : Statut_présence, variable qualitative binaire, nominale 
+ **Variable explicative** : 
+ Annee, variable qualitative ordinale 
+ Site, variable qualitative ordinale 
+ Observateurs, variable qualitative nominale
#### **Choix de la distribution de référence**

 => **Distribution Binomiale**


#### **Choix de la fonction de lien**

=> **logit** 

#### **Modèle mixte**


```{r}
mod3.0<- glmer(statut_presence~annee + observateurs_clean + (1|code_site), family=binomial(link = "logit"), data = base_greve_year_factor)
```

###  Vérification de l’ajustement du modèle aux données


**Vérification de l'indépendance des résidus**

```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod3.0)

```


#### **Remplacer la fonction de lien "logit" par "cauchit"**
```{r}
mod3.1<- glmer(statut_presence~annee + observateurs_clean + (1|code_site), family=binomial(link = "probit"), data = base_greve_year_factor)
```

###  Vérification de l’ajustement du modèle aux données


**Vérification de l'indépendance des résidus**
```{r, fig.cap="",fig.width = 7, fig.height = 5}
plotresid(mod3.1)

```
**Valeur des coefficients (estimate)**

```{r}
summary(mod3.1)
```





